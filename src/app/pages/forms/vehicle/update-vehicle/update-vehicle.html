<!-- update-vehicle.html -->
<div class="update-vehicle-container">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="pi pi-car"></i>
        Update Vehicle
      </h1>
      <p class="page-subtitle">Update vehicle information in the system</p>
    </div>
  </div>

  <p-card class="vehicle-form-card">
    <div class="form-container">
      <form (ngSubmit)="onSubmit()" #vehicleForm="ngForm">

        <!-- ── Basic Information ──────────────────────────────────────── -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="pi pi-info-circle"></i>
            Basic Information
          </h3>
          <div class="form-grid">

            <div class="form-field">
              <label for="investorNumber" class="field-label required">Investor Phone Number</label>
              <p-select id="investorNumber" [(ngModel)]="investorNumber" name="investorNumber"
                [options]="investorOptions" placeholder="Select an investor" optionLabel="label" optionValue="value"
                [filter]="true" filterPlaceholder="Search investors" [loading]="investorsLoading" [showClear]="true"
                styleClass="w-full" required [editable]="true">
              </p-select>
              <small class="field-hint">Format: 254XXXXXXXXX</small>
            </div>

            <!-- Fleet Number is read-only on update -->
            <div class="form-field">
              <label for="fleetNumber" class="field-label required">Fleet Number</label>
              <input pInputText id="fleetNumber" [value]="fleetNumber" name="fleetNumber" class="w-full" disabled
                readonly />
            </div>

            <div class="form-field">
              <label for="registrationNumber" class="field-label required">Registration Number</label>
              <input pInputText id="registrationNumber" [(ngModel)]="registrationNumber" name="registrationNumber"
                placeholder="Enter registration number" class="w-full" required />
            </div>

            <div class="form-field">
              <label for="capacity" class="field-label required">Capacity</label>
              <input pInputText type="number" id="capacity" [(ngModel)]="capacity" name="capacity"
                placeholder="Enter vehicle capacity" class="w-full" min="1" required />
            </div>

            <div class="form-field">
              <label for="marshalNumber" class="field-label required">Marshal Phone Number</label>
              <p-select id="marshalNumber" [(ngModel)]="marshalNumber" name="marshalNumber" [options]="marshalOptions"
                placeholder="Select a marshal" optionLabel="label" optionValue="value" [filter]="true"
                filterPlaceholder="Search marshals" [loading]="marshalsLoading" [showClear]="true" styleClass="w-full"
                required [editable]="true">
              </p-select>
              <small class="field-hint">Format: 254XXXXXXXXX</small>
            </div>

            <div class="form-field">
              <label for="storeNumber" class="field-label">Store Number</label>
              <input pInputText id="storeNumber" [(ngModel)]="storeNumber" name="storeNumber"
                placeholder="Enter store number (optional)" class="w-full" />
            </div>

            <div class="form-field">
              <label for="tillNumber" class="field-label">Till Number</label>
              <input pInputText id="tillNumber" [(ngModel)]="tillNumber" name="tillNumber"
                placeholder="Enter till number (optional)" class="w-full" />
            </div>

            <div class="form-field">
              <label for="stage" class="field-label required">Select Stage</label>
              <p-select id="stage" [(ngModel)]="selectedStage" name="stage" [options]="stageOptions"
                placeholder="Choose a stage" optionLabel="label" optionValue="value" [filter]="true"
                filterPlaceholder="Search stages" [loading]="stagesLoading" [showClear]="true" styleClass="w-full"
                required>
              </p-select>
            </div>

          </div>
        </div>

        <!-- ── Fee Structure ──────────────────────────────────────────── -->
        <div class="form-section">
          <div class="section-header-row">
            <h3 class="section-title">
              <i class="pi pi-money-bill"></i>
              Fee Structure
            </h3>

            <span *ngIf="organization" class="org-fee-badge">
              <i class="pi pi-building"></i>
              {{ organization.name }}
            </span>
          </div>

          <!-- Loading skeleton -->
          <div *ngIf="!initialDataLoaded" class="fee-skeleton">
            <div class="skeleton-row" *ngFor="let i of [1,2,3,4]"></div>
          </div>

          <!-- No fees configured warning -->
          <div *ngIf="initialDataLoaded && feeRows.length === 0" class="fee-empty-notice">
            <i class="pi pi-exclamation-triangle"></i>
            <span>No fee categories are configured for this organisation.</span>
          </div>

          <!-- Dynamic fee grid -->
          <div *ngIf="initialDataLoaded && feeRows.length > 0" class="form-grid">

            <div *ngFor="let row of feeRows" class="form-field" [class.fee-field--offload]="row.feeName === 'OFFLOAD'">

              <label [for]="row.modelKey" class="field-label required">
                <i [class]="'pi ' + row.icon + ' fee-label-icon'"></i>
                {{ row.label }}
              </label>

              <div class="fee-input-wrapper">
                <span class="fee-currency-prefix">KES</span>
                <input pInputText type="number" [id]="row.modelKey" [name]="row.modelKey"
                  [ngModel]="getFeeValue(row.modelKey)" (ngModelChange)="setFeeValue(row.modelKey, $event)"
                  placeholder="0.00" class="w-full fee-input" min="0" step="0.01" required />
              </div>

              <small *ngIf="row.hint" class="field-hint">{{ row.hint }}</small>
            </div>

          </div>
        </div>

        <!-- ── Actions ────────────────────────────────────────────────── -->
        <div class="form-actions">
          <p-button label="Cancel" icon="pi pi-times" iconPos="right" severity="secondary" [outlined]="true"
            [style]="{'gap':'1rem'}" (onClick)="onCancel()" [disabled]="submitting">
          </p-button>

          <p-button label="Update" icon="pi pi-check" iconPos="right" type="submit" [style]="{'gap':'1rem'}"
            [disabled]="!isFormValid() || submitting" [loading]="submitting">
          </p-button>
        </div>

      </form>
    </div>
  </p-card>

  <p-toast position="top-right"></p-toast>
</div>