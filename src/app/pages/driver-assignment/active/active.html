<!-- active.html -->
<p-toast position="top-right"></p-toast>

<div class="assignments-container">

  <!-- ─── Header ──────────────────────────────────────────────────────────── -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="pi pi-check-circle"></i>
        Active Driver Assignments
      </h1>
      <p class="page-subtitle">Manage active driver-fleet assignments</p>
    </div>

    <div class="header-controls">
      <div class="search-wrapper">
        <i class="pi pi-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Search driver, fleet, phone..." [(ngModel)]="searchTerm"
          (input)="onSearchChange()" />
        <button *ngIf="searchTerm" class="clear-btn" (click)="clearSearch()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <button class="icon-btn" (click)="refresh()" [disabled]="loading" pTooltip="Refresh">
        <i class="pi pi-refresh" [class.spinning]="loading"></i>
      </button>
    </div>
  </div>

  <!-- ─── Stats ────────────────────────────────────────────────────────────── -->
  <!-- <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon-box stat-blue"><i class="pi pi-users"></i></div>
      <div class="stat-body">
        <span class="stat-label">Active Drivers</span>
        <span class="stat-value">{{ totalDrivers }}</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-box stat-green"><i class="pi pi-car"></i></div>
      <div class="stat-body">
        <span class="stat-label">Unique Fleets</span>
        <span class="stat-value">{{ totalFleets }}</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-box stat-purple"><i class="pi pi-list"></i></div>
      <div class="stat-body">
        <span class="stat-label">Showing</span>
        <span class="stat-value">{{ filteredAssignments.length }}</span>
      </div>
    </div>
  </div> -->

  <!-- ─── Pagination Controls (Top) ────────────────────────────────────────── -->
  <div class="pagination-wrapper">
    <p-paginator [first]="first" [rows]="rows" [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[10, 20, 50, 100, 300, 500, 1000]" (onPageChange)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} assignments">
    </p-paginator>
  </div>

  <!-- ─── Table ─────────────────────────────────────────────────────────────── -->
  <div class="table-card">

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-overlay">
      <p-progressSpinner strokeWidth="4"></p-progressSpinner>
      <p>Loading assignments…</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && assignments.length === 0" class="empty-state">
      <i class="pi pi-inbox"></i>
      <h3>No active assignments found</h3>
      <p>Try adjusting your search filters.</p>
    </div>

    <!-- Table with Data -->
    <p-table *ngIf="!loading && assignments.length > 0" [value]="assignments" styleClass="p-datatable-gridlines"
      [tableStyle]="{ 'min-width': '50rem' }">

      <ng-template pTemplate="header">
        <tr>
          <th>Driver</th>
          <th>Phone</th>
          <th>Fleet / Reg</th>
          <th>Investor</th>
          <th>Marshal</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-assignment>
        <tr class="table-row" (click)="viewAssignmentDetails(assignment)">

          <td>
            <div class="driver-cell">
              <div class="driver-avatar">
                {{ assignment.firstName?.charAt(0) }}{{ assignment.lastName?.charAt(0) }}
              </div>
              <div>
                <div class="driver-name">{{ getFullName(assignment) }}</div>
                <div class="driver-sub">{{ assignment.username }}</div>
              </div>
            </div>
          </td>

          <td>
            <span class="mono-text">{{ assignment.phoneNumber }}</span>
          </td>

          <td>
            <div class="fleet-cell">
              <span class="fleet-number">{{ assignment.fleetNumber }}</span>
              <span class="reg-number">{{ assignment.registrationNumber }}</span>
            </div>
          </td>

          <td>
            <span class="mono-text">{{ assignment.investorNumber }}</span>
          </td>

          <td>
            <span class="mono-text">{{ assignment.marshalNumber }}</span>
          </td>

          <td>
            <span class="status-badge status-active">
              <i class="pi pi-check-circle"></i>
              Active
            </span>
          </td>

          <td (click)="$event.stopPropagation()">
            <div class="action-cell">
              <button class="action-btn btn-view" (click)="viewAssignmentDetails(assignment)" pTooltip="View details"
                tooltipPosition="top">
                <i class="pi pi-eye"></i>
              </button>

              <button class="action-btn btn-deactivate" (click)="openDeactivateDialog(assignment, $event)"
                pTooltip="Deactivate" tooltipPosition="top">
                <i class="pi pi-ban"></i>
              </button>
            </div>
          </td>

        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="empty-message-row">
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <h3>No assignments found</h3>
              <p>No data available for the current filters.</p>
            </div>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>

  <!-- ─── Pagination Controls (Bottom) ─────────────────────────────────────── -->
  <div class="pagination-wrapper" *ngIf="!loading && assignments.length > 0">
    <p-paginator [first]="first" [rows]="rows" [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[10, 20, 50, 100, 300, 500, 1000]" (onPageChange)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} assignments">
    </p-paginator>
  </div>

</div>

<!-- ══════════════════════════════════════════════════════════════
     DETAIL DIALOG
══════════════════════════════════════════════════════════════ -->
<p-dialog [(visible)]="displayDetailDialog" [modal]="true" [draggable]="false" [resizable]="false"
  styleClass="custom-dialog" [style]="{ width: '560px' }" (onHide)="closeDetailDialog()">
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <div class="dialog-header-top">
        <div class="dialog-header-icon">
          <i class="pi pi-id-card"></i>
        </div>
        <div>
          <h3 class="dialog-title">Assignment Details</h3>
          <p class="dialog-subtitle">Active driver-fleet information</p>
        </div>
      </div>
    </div>
  </ng-template>

  <div *ngIf="selectedAssignment" class="dialog-body">

    <!-- Driver info -->
    <div class="detail-section">
      <h4 class="detail-section-title"><i class="pi pi-user"></i> Driver</h4>
      <div class="detail-grid">
        <div class="detail-item">
          <span class="detail-label">Full Name</span>
          <span class="detail-value">{{ getFullName(selectedAssignment) }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Username</span>
          <span class="detail-value">{{ selectedAssignment.username }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Phone</span>
          <span class="detail-value mono">{{ selectedAssignment.phoneNumber }}</span>
        </div>
      </div>
    </div>

    <!-- Fleet info -->
    <div class="detail-section">
      <h4 class="detail-section-title"><i class="pi pi-car"></i> Fleet</h4>
      <div class="detail-grid">
        <div class="detail-item">
          <span class="detail-label">Fleet Number</span>
          <span class="detail-value mono">{{ selectedAssignment.fleetNumber }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Registration</span>
          <span class="detail-value mono">{{ selectedAssignment.registrationNumber }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Investor</span>
          <span class="detail-value mono">{{ selectedAssignment.investorNumber }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Marshal</span>
          <span class="detail-value mono">{{ selectedAssignment.marshalNumber }}</span>
        </div>
      </div>
    </div>

  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button class="footer-btn btn-secondary" (click)="closeDetailDialog()">
        <i class="pi pi-times"></i> Close
      </button>
      <button class="footer-btn btn-danger" (click)="openDeactivateDialog(selectedAssignment!)">
        <i class="pi pi-ban"></i> Deactivate
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- ══════════════════════════════════════════════════════════════
     DEACTIVATION CONFIRMATION DIALOG
══════════════════════════════════════════════════════════════ -->
<p-dialog [(visible)]="displayDeactivateDialog" [modal]="true" [draggable]="false" [resizable]="false"
  styleClass="custom-dialog" [style]="{ width: '460px' }" (onHide)="closeDeactivateDialog()">
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <div class="dialog-header-top">
        <div class="dialog-header-icon icon-warning">
          <i class="pi pi-exclamation-triangle"></i>
        </div>
        <div>
          <h3 class="dialog-title">Confirm Deactivation</h3>
          <p class="dialog-subtitle">This action will remove the driver from active duty</p>
        </div>
      </div>
    </div>
  </ng-template>

  <div class="confirm-body" *ngIf="selectedAssignment">
    <p class="confirm-message">
      Are you sure you want to deactivate the assignment for
      <strong>{{ getFullName(selectedAssignment) }}</strong>
      on fleet <strong class="mono">{{ selectedAssignment.fleetNumber }}</strong>?
    </p>

    <div class="confirm-detail-card">
      <div class="confirm-detail-row">
        <span class="confirm-label">Driver</span>
        <span class="confirm-value">{{ getFullName(selectedAssignment) }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Phone</span>
        <span class="confirm-value mono">{{ selectedAssignment.phoneNumber }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Fleet</span>
        <span class="confirm-value mono">{{ selectedAssignment.fleetNumber }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Registration</span>
        <span class="confirm-value mono">{{ selectedAssignment.registrationNumber }}</span>
      </div>
    </div>

    <div class="confirm-warning-note">
      <i class="pi pi-info-circle"></i>
      The driver's assignment status will be set to <strong>INACTIVE</strong>.
      They can be re-assigned to a fleet at any time.
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button class="footer-btn btn-secondary" (click)="closeDeactivateDialog()" [disabled]="deactivating">
        <i class="pi pi-times"></i> Cancel
      </button>

      <button class="footer-btn btn-danger" (click)="confirmDeactivate()" [disabled]="deactivating">
        <span *ngIf="!deactivating">
          <i class="pi pi-ban"></i> Deactivate
        </span>
        <span *ngIf="deactivating">
          <i class="pi pi-spin pi-spinner"></i> Deactivating…
        </span>
      </button>
    </div>
  </ng-template>
</p-dialog>