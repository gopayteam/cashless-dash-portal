<!-- pending.html -->
<p-toast position="top-right"></p-toast>

<div class="assignments-container">

  <!-- ─── Header ──────────────────────────────────────────────────────────── -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="pi pi-clock"></i>
        Pending Driver Assignments
      </h1>
      <p class="page-subtitle">Review and approve driver-fleet assignment requests</p>
    </div>

    <div class="header-controls">
      <div class="search-wrapper">
        <i class="pi pi-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Search driver, fleet, phone..." [(ngModel)]="searchTerm"
          (input)="onSearchChange()" />
        <button *ngIf="searchTerm" class="clear-btn" (click)="clearSearch()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <button class="icon-btn" (click)="refresh()" [disabled]="loading" pTooltip="Refresh">
        <i class="pi pi-refresh" [class.spinning]="loading"></i>
      </button>
    </div>
  </div>

  <!-- ─── Stats ────────────────────────────────────────────────────────────── -->
  <!-- <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon-box stat-blue"><i class="pi pi-users"></i></div>
      <div class="stat-body">
        <span class="stat-label">Total Requests</span>
        <span class="stat-value">{{ totalDrivers }}</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-box stat-orange"><i class="pi pi-clock"></i></div>
      <div class="stat-body">
        <span class="stat-label">Pending</span>
        <span class="stat-value">{{ pendingApprovals }}</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-box stat-green"><i class="pi pi-car"></i></div>
      <div class="stat-body">
        <span class="stat-label">Unique Fleets</span>
        <span class="stat-value">{{ totalFleets }}</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-box stat-purple"><i class="pi pi-list"></i></div>
      <div class="stat-body">
        <span class="stat-label">Showing</span>
        <span class="stat-value">{{ filteredAssignments.length }}</span>
      </div>
    </div>
  </div> -->

  <!-- ─── Pagination Controls (Top) ────────────────────────────────────────── -->
  <div class="pagination-wrapper">
    <p-paginator [first]="first" [rows]="rows" [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[10, 20, 50, 100, 300, 500, 1000]" (onPageChange)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} assignments">
    </p-paginator>
  </div>

  <!-- ─── Table ─────────────────────────────────────────────────────────────── -->
  <div class="table-card">

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-overlay">
      <p-progressSpinner strokeWidth="4"></p-progressSpinner>
      <p>Loading assignments…</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && assignments.length === 0" class="empty-state">
      <i class="pi pi-inbox"></i>
      <h3>No pending assignments found</h3>
      <p>Try adjusting your search filters.</p>
    </div>

    <!-- Table with Data -->
    <p-table *ngIf="!loading && assignments.length > 0" [value]="assignments" styleClass="p-datatable-gridlines"
      [tableStyle]="{ 'min-width': '50rem' }">

      <ng-template pTemplate="header">
        <tr>
          <th>Driver</th>
          <th>Phone</th>
          <th>Fleet / Reg</th>
          <th>Investor</th>
          <th>Marshal</th>
          <th>Status</th>
          <th>Approvals</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-assignment>
        <tr class="table-row" (click)="viewAssignmentDetails(assignment)">

          <td>
            <div class="driver-cell">
              <div class="driver-avatar">
                {{ assignment.firstName?.charAt(0) }}{{ assignment.lastName?.charAt(0) }}
              </div>
              <div>
                <div class="driver-name">{{ getFullName(assignment) }}</div>
                <div class="driver-sub">{{ assignment.username }}</div>
              </div>
            </div>
          </td>

          <td>
            <span class="mono-text">{{ assignment.phoneNumber }}</span>
          </td>

          <td>
            <div class="fleet-cell">
              <span class="fleet-number">{{ assignment.fleetNumber }}</span>
              <span class="reg-number">{{ assignment.registrationNumber }}</span>
            </div>
          </td>

          <td>
            <span class="mono-text">{{ assignment.investorNumber }}</span>
          </td>

          <td>
            <span class="mono-text">{{ assignment.marshalNumber }}</span>
          </td>

          <td>
            <span [class]="'status-badge status-' + getApprovalStatusClass(assignment.approvalStatus)">
              <i [class]="getApprovalStatusIcon(assignment.approvalStatus)"></i>
              {{ assignment.approvalStatus }}
            </span>
          </td>

          <td>
            <div class="approval-count">
              <i class="pi pi-thumbs-up"></i>
              <span>{{ assignment.approvalCount }}</span>
            </div>
          </td>

          <td (click)="$event.stopPropagation()">
            <div class="action-cell">
              <button class="action-btn btn-view" (click)="viewAssignmentDetails(assignment)" pTooltip="View details"
                tooltipPosition="top">
                <i class="pi pi-eye"></i>
              </button>

              <button *ngIf="assignment.approvalStatus === 'PENDING'" class="action-btn btn-approve"
                (click)="openApproveDialog(assignment, $event)" pTooltip="Approve" tooltipPosition="top">
                <i class="pi pi-check"></i>
              </button>

              <button *ngIf="assignment.approvalStatus === 'PENDING'" class="action-btn btn-reject"
                (click)="openRejectDialog(assignment, $event)" pTooltip="Reject" tooltipPosition="top">
                <i class="pi pi-times"></i>
              </button>
            </div>
          </td>

        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="empty-message-row">
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <h3>No assignments found</h3>
              <p>No data available for the current filters.</p>
            </div>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>

  <!-- ─── Pagination Controls (Bottom) ─────────────────────────────────────── -->
  <div class="pagination-wrapper" *ngIf="!loading && assignments.length > 0">
    <p-paginator [first]="first" [rows]="rows" [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[10, 20, 50, 100, 300, 500, 1000]" (onPageChange)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} assignments">
    </p-paginator>
  </div>

</div>

<!-- ══════════════════════════════════════════════════════════════
     DETAIL DIALOG
══════════════════════════════════════════════════════════════ -->
<p-dialog [(visible)]="displayDetailDialog" [modal]="true" [draggable]="false" [resizable]="false"
  styleClass="custom-dialog" [style]="{ width: '560px' }" (onHide)="closeDetailDialog()">
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <div class="dialog-header-top">
        <div class="dialog-header-icon">
          <i class="pi pi-clock"></i>
        </div>
        <div>
          <h3 class="dialog-title">Assignment Details</h3>
          <p class="dialog-subtitle">Pending driver-fleet information</p>
        </div>
      </div>
    </div>
  </ng-template>

  <div *ngIf="selectedAssignment" class="dialog-body">

    <!-- Status info -->
    <div class="detail-section">
      <h4 class="detail-section-title"><i class="pi pi-info-circle"></i> Status</h4>
      <div class="detail-grid">
        <div class="detail-item">
          <span class="detail-label">Approval Status</span>
          <span [class]="'status-badge status-' + getApprovalStatusClass(selectedAssignment.approvalStatus)">
            <i [class]="getApprovalStatusIcon(selectedAssignment.approvalStatus)"></i>
            {{ selectedAssignment.approvalStatus }}
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Approval Count</span>
          <span class="detail-value">{{ selectedAssignment.approvalCount }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Approved</span>
          <span class="detail-value">{{ selectedAssignment.approved ? 'Yes' : 'No' }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Active Days</span>
          <span class="detail-value">{{ selectedAssignment.allowedActiveDays }}</span>
        </div>
      </div>
    </div>

    <!-- Driver info -->
    <div class="detail-section">
      <h4 class="detail-section-title"><i class="pi pi-user"></i> Driver</h4>
      <div class="detail-grid">
        <div class="detail-item">
          <span class="detail-label">Full Name</span>
          <span class="detail-value">{{ getFullName(selectedAssignment) }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Username</span>
          <span class="detail-value">{{ selectedAssignment.username }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Phone</span>
          <span class="detail-value mono">{{ selectedAssignment.phoneNumber }}</span>
        </div>
      </div>
    </div>

    <!-- Fleet info -->
    <div class="detail-section">
      <h4 class="detail-section-title"><i class="pi pi-car"></i> Fleet</h4>
      <div class="detail-grid">
        <div class="detail-item">
          <span class="detail-label">Fleet Number</span>
          <span class="detail-value mono">{{ selectedAssignment.fleetNumber }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Registration</span>
          <span class="detail-value mono">{{ selectedAssignment.registrationNumber }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Investor</span>
          <span class="detail-value mono">{{ selectedAssignment.investorNumber }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Marshal</span>
          <span class="detail-value mono">{{ selectedAssignment.marshalNumber }}</span>
        </div>
      </div>
    </div>

  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button class="footer-btn btn-secondary" (click)="closeDetailDialog()">
        <i class="pi pi-times"></i> Close
      </button>
      <div *ngIf="selectedAssignment?.approvalStatus === 'PENDING'" class="footer-actions-group">
        <button class="footer-btn btn-danger" (click)="openRejectDialog(selectedAssignment!)">
          <i class="pi pi-times"></i> Reject
        </button>
        <button class="footer-btn btn-success" (click)="openApproveDialog(selectedAssignment!)">
          <i class="pi pi-check"></i> Approve
        </button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- ══════════════════════════════════════════════════════════════
     APPROVE CONFIRMATION DIALOG
══════════════════════════════════════════════════════════════ -->
<p-dialog [(visible)]="displayApproveDialog" [modal]="true" [draggable]="false" [resizable]="false"
  styleClass="custom-dialog" [style]="{ width: '460px' }" (onHide)="closeApproveDialog()">
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <div class="dialog-header-top">
        <div class="dialog-header-icon icon-success">
          <i class="pi pi-check-circle"></i>
        </div>
        <div>
          <h3 class="dialog-title">Confirm Approval</h3>
          <p class="dialog-subtitle">Approve this driver assignment request</p>
        </div>
      </div>
    </div>
  </ng-template>

  <div class="confirm-body" *ngIf="selectedAssignment">
    <p class="confirm-message">
      Are you sure you want to approve the assignment for
      <strong>{{ getFullName(selectedAssignment) }}</strong>
      on fleet <strong class="mono">{{ selectedAssignment.fleetNumber }}</strong>?
    </p>

    <div class="confirm-detail-card">
      <div class="confirm-detail-row">
        <span class="confirm-label">Driver</span>
        <span class="confirm-value">{{ getFullName(selectedAssignment) }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Phone</span>
        <span class="confirm-value mono">{{ selectedAssignment.phoneNumber }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Fleet</span>
        <span class="confirm-value mono">{{ selectedAssignment.fleetNumber }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Registration</span>
        <span class="confirm-value mono">{{ selectedAssignment.registrationNumber }}</span>
      </div>
    </div>

    <div class="confirm-success-note">
      <i class="pi pi-info-circle"></i>
      The driver's assignment status will be set to <strong>APPROVED</strong>.
      They will be able to start operating on this fleet.
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button class="footer-btn btn-secondary" (click)="closeApproveDialog()" [disabled]="processing">
        <i class="pi pi-times"></i> Cancel
      </button>

      <button class="footer-btn btn-success" (click)="confirmApprove()" [disabled]="processing">
        <span *ngIf="!processing">
          <i class="pi pi-check"></i> Approve
        </span>
        <span *ngIf="processing">
          <i class="pi pi-spin pi-spinner"></i> Processing…
        </span>
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- ══════════════════════════════════════════════════════════════
     REJECT CONFIRMATION DIALOG
══════════════════════════════════════════════════════════════ -->
<p-dialog [(visible)]="displayRejectDialog" [modal]="true" [draggable]="false" [resizable]="false"
  styleClass="custom-dialog" [style]="{ width: '460px' }" (onHide)="closeRejectDialog()">
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <div class="dialog-header-top">
        <div class="dialog-header-icon icon-warning">
          <i class="pi pi-exclamation-triangle"></i>
        </div>
        <div>
          <h3 class="dialog-title">Confirm Rejection</h3>
          <p class="dialog-subtitle">Reject this driver assignment request</p>
        </div>
      </div>
    </div>
  </ng-template>

  <div class="confirm-body" *ngIf="selectedAssignment">
    <p class="confirm-message">
      Are you sure you want to reject the assignment for
      <strong>{{ getFullName(selectedAssignment) }}</strong>
      on fleet <strong class="mono">{{ selectedAssignment.fleetNumber }}</strong>?
    </p>

    <div class="confirm-detail-card">
      <div class="confirm-detail-row">
        <span class="confirm-label">Driver</span>
        <span class="confirm-value">{{ getFullName(selectedAssignment) }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Phone</span>
        <span class="confirm-value mono">{{ selectedAssignment.phoneNumber }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Fleet</span>
        <span class="confirm-value mono">{{ selectedAssignment.fleetNumber }}</span>
      </div>
      <div class="confirm-detail-row">
        <span class="confirm-label">Registration</span>
        <span class="confirm-value mono">{{ selectedAssignment.registrationNumber }}</span>
      </div>
    </div>

    <div class="confirm-warning-note">
      <i class="pi pi-info-circle"></i>
      The driver's assignment status will be set to <strong>REJECTED</strong>.
      They will need to submit a new request to be assigned to this fleet.
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button class="footer-btn btn-secondary" (click)="closeRejectDialog()" [disabled]="processing">
        <i class="pi pi-times"></i> Cancel
      </button>

      <button class="footer-btn btn-danger" (click)="confirmReject()" [disabled]="processing">
        <span *ngIf="!processing">
          <i class="pi pi-ban"></i> Reject
        </span>
        <span *ngIf="processing">
          <i class="pi pi-spin pi-spinner"></i> Processing…
        </span>
      </button>
    </div>
  </ng-template>
</p-dialog>