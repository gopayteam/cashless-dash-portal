<!-- pages/deleted-parcels/deleted-parcels.component.html -->
<div class="parcels-container">
  <!-- ================= HEADER ================= -->
  <div class="parcels-header">
    <div class="header-content">
      <h1>Deleted Parcels</h1>
      <p class="text-muted">View and manage deleted parcel records</p>
    </div>

    <div class="filter-item-gradient filter-item-filled">
      <label class="filter-label">Date Range</label>
      <mat-form-field appearance="outline" class="date-range-field">
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate placeholder="Start date" [(ngModel)]="filters.dateRange[0]" />
          <input matEndDate placeholder="End date" [(ngModel)]="filters.dateRange[1]" />
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker (closed)="applyFilters()"></mat-date-range-picker>
      </mat-form-field>
    </div>
  </div>

  <!-- ================= STATS CARDS ================= -->
  <div class="stats-grid grid-3">
    <p-card styleClass="card-hover">
      <div class="stat-content">
        <div class="stat-info">
          <span class="stat-title">Total Deleted</span>
          <h2 class="stat-value">
            <span class="amount">{{ totalRecords | number }}</span>
          </h2>
        </div>
        <div class="stat-icon" style="background-color: #ef444420">
          <i class="pi pi-trash" style="color: #ef4444"></i>
        </div>
      </div>
    </p-card>

    <p-card styleClass="card-hover">
      <div class="stat-content">
        <div class="stat-info">
          <span class="stat-title">Current View</span>
          <h2 class="stat-value">
            <span class="amount">{{ deletedParcels.length | number }}</span>
          </h2>
        </div>
        <div class="stat-icon" style="background-color: #3b82f620">
          <i class="pi pi-eye" style="color: #3b82f6"></i>
        </div>
      </div>
    </p-card>

    <p-card styleClass="card-hover">
      <div class="stat-content">
        <div class="stat-info">
          <span class="stat-title">Date Range</span>
          <h2 class="stat-value">
            <span class="amount" style="font-size: 1rem;">
              {{ filters.dateRange[0] | date: 'dd/MM' }} - {{ filters.dateRange[1] | date: 'dd/MM' }}
            </span>
          </h2>
        </div>
        <div class="stat-icon" style="background-color: #f59e0b20">
          <i class="pi pi-calendar" style="color: #f59e0b"></i>
        </div>
      </div>
    </p-card>
  </div>

  <!-- ================= FILTER SECTION ================= -->
  <p-card styleClass="stat-card card filter-card">
    <div class="filters-grid">
      <div class="filter-group">
        <label class="filter-label">Parcel Number</label>
        <input pInputText placeholder="Search by parcel number..." [(ngModel)]="filters.parcelNumber"
          class="form-input" />
      </div>

      <div class="filter-group">
        <label class="filter-label">Sender Name</label>
        <input pInputText placeholder="Sender name..." [(ngModel)]="filters.senderName" class="form-input" />
      </div>

      <div class="filter-group">
        <label class="filter-label">Receiver Name</label>
        <input pInputText placeholder="Receiver name..." [(ngModel)]="filters.receiverName" class="form-input" />
      </div>

      <div class="filter-actions">
        <button pButton icon="pi pi-filter" label="Apply" class="filter-btn filter-btn--apply" (click)="applyFilters()">
        </button>

        <button pButton icon="pi pi-refresh" label="Reset" class="filter-btn filter-btn--reset"
          (click)="resetFilters()">
        </button>
      </div>
    </div>
  </p-card>

  <!-- ================= DELETED PARCELS TABLE ================= -->
  <p-card styleClass="stat-card card">
    <div class="table-header">
      <div class="table-header-left">
        <h3>Deleted Parcels List</h3>
        <span class="record-count">{{ totalRecords }} total deleted parcels</span>
      </div>
      <div class="search-container">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText type="text" placeholder="Search parcels..." [(ngModel)]="searchTerm"
            (input)="onSearchChange()" class="search-input" />
        </span>
        <button *ngIf="searchTerm" pButton icon="pi pi-times" class="p-button-text p-button-sm clear-button"
          (click)="clearSearch()" pTooltip="Clear search"></button>
      </div>
    </div>

    <p-table [value]="deletedParcels" [lazy]="true" [paginator]="true" [rows]="rows" [first]="first"
      [loading]="loading()" [totalRecords]="totalRecords" [rowsPerPageOptions]="[10, 20, 30, 50, 100]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first}â€“{last} of {totalRecords} deleted parcels" styleClass="data-table"
      (onLazyLoad)="loadDeletedParcels($event)" [tableStyle]="{ 'min-width': '60rem' }">
      <ng-template pTemplate="header">
        <tr>
          <th>Parcel Number</th>
          <th>Sender</th>
          <th>Receiver</th>
          <th>Route</th>
          <th>Fleet No</th>
          <th>Amount</th>
          <!-- <th>Payment Method</th> -->
          <!-- <th>Parcel Status</th> -->
          <th>Deleted Date</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-parcel>
        <tr class="clickable-row deleted-row" (click)="viewParcelDetails(parcel)">
          <td>
            <span class="receipt-number">{{ parcel.parcelNumber }}</span>
          </td>

          <td>
            <div class="customer-cell">
              <i class="pi pi-user"></i>
              <div class="customer-info">
                <span class="customer-name">{{ parcel.sender.name }}</span>
                <span class="customer-phone">{{ parcel.sender.phoneNumber }}</span>
              </div>
            </div>
          </td>

          <td>
            <div class="customer-cell">
              <i class="pi pi-user"></i>
              <div class="customer-info">
                <span class="customer-name">{{ parcel.receiver.name }}</span>
                <span class="customer-phone">{{ parcel.receiver.phoneNumber }}</span>
              </div>
            </div>
          </td>

          <td>
            <div class="route-cell">
              <span class="route-point">
                <i class="pi pi-map-marker"></i>
                Source: {{ parcel.source }}
              </span>
              <i class="pi pi-arrow-right route-arrow"></i>
              <span class="route-point">
                <i class="pi pi-map-marker"></i>
                Dest: {{ parcel.destination }}
              </span>
            </div>
          </td>

          <td>
            <span class="fleet-badge">
              <i class="pi pi-car"></i>
              {{ parcel.fleetNo ?? 'N/A' }}
            </span>
          </td>

          <td class="amount-cell">
            <span class="amount">Ksh {{ parcel.amount | number : '1.2-2' }}</span>
          </td>

          <!-- <td>
            <span [class]="'badge ' + getPaymentMethodClass(parcel.paymentMethod)">
              <i [class]="parcel.paymentMethod === 'CASH' ? 'pi pi-money-bill' : 'pi pi-credit-card'"></i>
              {{ parcel.paymentMethod }}
            </span>
          </td> -->

          <!-- <td>
            <span [class]="'badge ' + getStatusClass(parcel.parcelStatus)">
              <i [class]="
                  parcel.parcelStatus === 'ARRIVED'
                    ? 'pi pi-inbox'
                    : parcel.parcelStatus === 'IN_TRANSIT'
                      ? 'pi pi-truck'
                      : 'pi pi-box'
                "></i>
              {{ parcel.parcelStatus.replace('_', ' ') }}
            </span>
          </td> -->

          <td>
            <div class="date-cell">
              <span class="date">{{ parcel.createdAt | date : 'dd MMM yyyy' }}</span>
              <span class="time">{{ parcel.createdAt | date : 'hh:mm a' }}</span>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="empty-message">
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <h3>No Deleted Parcels Found</h3>
              <p>Try adjusting your filters or date range</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- ================= PARCEL DETAILS DIALOG ================= -->
  <p-dialog [(visible)]="displayDetailDialog" [modal]="true" [closable]="true" [dismissableMask]="true"
    [draggable]="false" [resizable]="false" styleClass="custom-dialog"
    [style]="{ width: '90vw', maxWidth: '900px', background: '#f9f9f9'  }">
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <div class="dialog-header-top">
          <div class="dialog-icon">
            <i class="pi pi-trash"></i>
          </div>
          <div class="dialog-title-section">
            <h2>Deleted Parcel Details</h2>
            <span class="receipt-number-large">{{ selectedParcel?.parcelNumber }}</span>
          </div>
        </div>
      </div>
    </ng-template>

    <div class="detail-content" *ngIf="selectedParcel">
      <div class="detail-grid">
        <!-- Left Column -->
        <div class="detail-column">
          <div class="detail-section">
            <h4 class="section-title">Parcel Information</h4>

            <div class="detail-item">
              <label>Parcel Number</label>
              <span class="value code-value">{{ selectedParcel.parcelNumber }}</span>
            </div>

            <div class="detail-item">
              <label>Created Date</label>
              <span class="value">
                {{ selectedParcel.createdAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item">
              <label>Description</label>
              <span class="value">{{ selectedParcel.description || 'N/A' }}</span>
            </div>

            <div class="detail-item">
              <label>Parcel Value</label>
              <span class="value">Ksh {{ selectedParcel.value ?? 0 | number : '1.2-2' }}</span>
            </div>

            <div class="detail-item">
              <label>Service Charge</label>
              <span class="value">Ksh {{ selectedParcel.serviceCharge | number : '1.2-2' }}</span>
            </div>

            <div class="detail-item">
              <label>Total Amount</label>
              <span class="value amount-highlight">
                Ksh {{ selectedParcel.amount | number : '1.2-2' }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4 class="section-title">Sender Information</h4>

            <div class="detail-item">
              <label>Sender Name</label>
              <span class="value">{{ selectedParcel.sender.name }}</span>
            </div>

            <div class="detail-item">
              <label>Sender Phone</label>
              <span class="value contact-value">
                <i class="pi pi-phone"></i>
                {{ selectedParcel.sender.phoneNumber }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.sender.idNumber">
              <label>ID Number</label>
              <span class="value code-value">{{ selectedParcel.sender.idNumber }}</span>
            </div>

            <div class="detail-item">
              <label>Source Location</label>
              <span class="value fleet-highlight">
                <i class="pi pi-map-marker"></i>
                Location ID: {{ selectedParcel.source }}
              </span>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="detail-column">
          <div class="detail-section">
            <h4 class="section-title">Receiver Information</h4>

            <div class="detail-item">
              <label>Receiver Name</label>
              <span class="value">{{ selectedParcel.receiver.name }}</span>
            </div>

            <div class="detail-item">
              <label>Receiver Phone</label>
              <span class="value contact-value">
                <i class="pi pi-phone"></i>
                {{ selectedParcel.receiver.phoneNumber }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.receiver.idNumber">
              <label>ID Number</label>
              <span class="value code-value">{{ selectedParcel.receiver.idNumber }}</span>
            </div>

            <div class="detail-item">
              <label>Destination</label>
              <span class="value fleet-highlight">
                <i class="pi pi-map-marker"></i>
                Location ID: {{ selectedParcel.destination }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.via">
              <label>Via</label>
              <span class="value">Location ID: {{ selectedParcel.via }}</span>
            </div>

            <div class="detail-item">
              <label>Fleet Number</label>
              <span class="value fleet-highlight">
                <i class="pi pi-car"></i>
                {{ selectedParcel.fleetNo || 'N/A' }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4 class="section-title">Status & Payment</h4>

            <div class="detail-item">
              <label>Parcel Status</label>
              <span [class]="'value badge ' + getStatusClass(selectedParcel.parcelStatus)">
                {{ selectedParcel.parcelStatus.replace('_', ' ') }}
              </span>
            </div>

            <div class="detail-item">
              <label>Payment Status</label>
              <span [class]="'value badge ' + getPaymentStatusClass(selectedParcel.paymentStatus)">
                {{ selectedParcel.paymentStatus }}
              </span>
            </div>

            <div class="detail-item">
              <label>Payment Method</label>
              <span [class]="'value badge ' + getPaymentMethodClass(selectedParcel.paymentMethod)">
                {{ selectedParcel.paymentMethod }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.mpesaReceiptNumber">
              <label>M-Pesa Receipt</label>
              <span class="value code-value">{{ selectedParcel.mpesaReceiptNumber }}</span>
            </div>

            <div class="detail-item">
              <label>Created By</label>
              <span class="value">{{ selectedParcel.username }}</span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.dispatchedAt">
              <label>Dispatched At</label>
              <span class="value">
                {{ selectedParcel.dispatchedAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.arrivedAt">
              <label>Arrived At</label>
              <span class="value">
                {{ selectedParcel.arrivedAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.pickedAt">
              <label>Picked At</label>
              <span class="value">
                {{ selectedParcel.pickedAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.expense">
              <label>Expense</label>
              <span class="value">Ksh {{ selectedParcel.expense | number : '1.2-2' }}</span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.expenseDescription">
              <label>Expense Description</label>
              <span class="value">{{ selectedParcel.expenseDescription }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton label="Close" icon="pi pi-times" iconPos="right" style="gap: 0.5rem;" class="p-button-text"
        (click)="closeDetailDialog()"></button>
    </ng-template>
  </p-dialog>
</div>