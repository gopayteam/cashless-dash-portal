<!-- pages/parcels/parcels.component.html -->
<div class="parcels-container">
  <!-- ================= HEADER ================= -->
  <div class="parcels-header">
    <div class="header-content">
      <h1>Parcel Management</h1>
      <p class="text-muted">Track and manage all parcel shipments</p>
    </div>

    <div class="filter-item-gradient filter-item-filled">
      <label class="filter-label">Date Range (Server Filter)</label>
      <mat-form-field appearance="outline" class="date-range-field">
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate placeholder="Start date" [(ngModel)]="filters.dateRange[0]" />
          <input matEndDate placeholder="End date" [(ngModel)]="filters.dateRange[1]" />
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker (closed)="loadParcels({ first: 0, rows: rows })"></mat-date-range-picker>
      </mat-form-field>
    </div>
  </div>

  <!-- ================= FILTER SECTION ================= -->
  <p-card styleClass="stat-card card filter-card">
    <div class="filters-section">
      <!-- Primary Filters Row -->
      <div class="filters-grid">
        <div class="filter-item">
          <label class="filter-label">Source Stage</label>
          <p-select [options]="sourceStages" [(ngModel)]="filters.sourceId" optionLabel="name" optionValue="id"
            placeholder="Select Source" [showClear]="true" (onChange)="applyFilters()" styleClass="filter-dropdown">

            <ng-template pTemplate="selectedItem" let-option>
              <div class="flex align-items-center gap-2" *ngIf="option">
                <i class="pi pi-map-marker"></i>
                <span> {{ option.name }}</span>
              </div>
            </ng-template>

            <ng-template pTemplate="item" let-option>
              <div class="flex align-items-center gap-2">
                <i class="pi pi-map-marker"></i>
                <span> {{ option.name }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>

        <div class="filter-item">
          <label class="filter-label">Destination Stage</label>
          <p-select [options]="destinationStages" [(ngModel)]="filters.destinationId" optionLabel="name"
            optionValue="id" placeholder="Select Destination" [showClear]="true" (onChange)="applyFilters()"
            styleClass="filter-dropdown">
          </p-select>

        </div>

        <div class="filter-item">
          <label class="filter-label">Payment Method</label>
          <p-select [options]="paymentMethodOptions" [(ngModel)]="filters.paymentMethod" optionLabel="label"
            optionValue="value" placeholder="Select Payment Method" [showClear]="true" (onChange)="applyFilters()"
            styleClass="filter-dropdown">

            <ng-template pTemplate="item" let-option>
              <div class="flex align-items-center gap-2">
                <i [class]="option.value === 'CASH' ? 'pi pi-money-bill' : 'pi pi-credit-card'"></i>
                <span> {{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>

        </div>

        <div class="filter-item">
          <label class="filter-label">Parcel Status</label>
          <p-select [options]="parcelStatusOptions" [(ngModel)]="filters.parcelStatus" optionLabel="label"
            optionValue="value" placeholder="Select Parcel Status" [showClear]="true" (onChange)="applyFilters()"
            styleClass="filter-dropdown">

            <ng-template pTemplate="item" let-option>
              <div class="flex align-items-center gap-2">
                <i [class]="option.icon"></i>
                <span> {{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>

        </div>

        <!-- <div class="filter-item filter-item-filled">
          <label class="filter-label">Date Range (Server Filter)</label>
          <mat-form-field appearance="outline" class="date-range-field">
            <mat-date-range-input [rangePicker]="picker">
              <input matStartDate placeholder="Start date" [(ngModel)]="filters.dateRange[0]" />
              <input matEndDate placeholder="End date" [(ngModel)]="filters.dateRange[1]" />
            </mat-date-range-input>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-date-range-picker #picker (closed)="loadParcels({ first: 0, rows: rows })"></mat-date-range-picker>
          </mat-form-field>
        </div> -->
      </div>



      <!-- Action Buttons Row -->
      <div class="filter-actions-row">

        <div class="filter-buttons-group">
          <button pButton icon="pi pi-filter" label="Apply Filters" class="p-button-primary filter-action-btn"
            (click)="applyFilters()">
          </button>
          <button pButton icon="pi pi-refresh" label="Reset" class="p-button-outlined filter-action-btn"
            (click)="resetFilters()">
          </button>
        </div>

        <div class="export-buttons-group">
          <button pButton icon="pi pi-file-excel" label="Excel" class="p-button-success export-action-btn"
            [disabled]="parcels.length === 0 || isExporting" [loading]="isExporting" (click)="exportToExcel()"
            pTooltip="Export to Excel" tooltipPosition="bottom">
          </button>
          <button pButton icon="pi pi-file" label="CSV" class="p-button-help export-action-btn"
            [disabled]="parcels.length === 0 || isExporting" [loading]="isExporting" (click)="exportToCSV()"
            pTooltip="Export to CSV" tooltipPosition="bottom">
          </button>
        </div>
      </div>
    </div>
  </p-card>

  <!-- ================= STATS CARDS ================= -->
  <div class="stats-grid">
    <p-card *ngFor="let card of statsCards" styleClass="card-hover stat-card-item">
      <div class="stat-content">
        <div class="stat-info">
          <span class="stat-title">{{ card.title }}</span>
          <h2 class="stat-value">
            <ng-container *ngIf="card.amount !== undefined; else countValue">
              <span class="currency">{{ card.currency }}</span>
              <span class="amount">{{ card.amount | number : '1.0-2' }}</span>
            </ng-container>

            <ng-template #countValue>
              <span class="amount">{{ card.count | number }}</span>
            </ng-template>
          </h2>

          <span class="stat-change positive" *ngIf="card.change">
            <i class="pi pi-arrow-up"></i> {{ card.change }}
          </span>
        </div>

        <div class="stat-icon" [style.background-color]="card.color + '20'">
          <i [class]="'pi ' + card.icon" [style.color]="card.color"></i>
        </div>
      </div>
    </p-card>
  </div>

  <!-- ================= PARCELS TABLE ================= -->
  <p-card styleClass="stat-card card">
    <div class="table-header">
      <div class="table-header-left">
        <h3>Parcels List</h3>
        <span class="record-count">{{ totalRecords }} parcels</span>
      </div>

      <div class="table-search">
        <span class="p-input-icon-left search-wrapper">
          <i class="pi pi-search"></i>
          <input pInputText type="text" placeholder="Search by Parcel Number" [(ngModel)]="filters.parcelNumber"
            (input)="onParcelNumberChange()" class="search-input" />
          <i class="pi pi-times clear-icon" *ngIf="filters.parcelNumber" (click)="clearSearch()"></i>
        </span>
      </div>
    </div>

    <p-table [value]="parcels" [paginator]="true" [rows]="rows" [loading]="loading()" [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[10, 20, 30, 50, 100]" [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first}â€“{last} of {totalRecords} parcels" styleClass="data-table"
      [tableStyle]="{ 'min-width': '60rem' }" [lazy]="true" (onLazyLoad)="loadParcels($event)"
      responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>Parcel Number</th>
          <th>Sender</th>
          <th>Receiver</th>
          <th>Route</th>
          <th class="hide-mobile">Fleet No</th>
          <th>Amount</th>
          <th class="hide-mobile">Payment Method</th>
          <th>Status</th>
          <th>Receipt</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-parcel>
        <tr class="clickable-row" (click)="viewParcelDetails(parcel)">
          <td>
            <span class="receipt-number">{{ parcel.parcelNumber }}</span>
          </td>

          <td>
            <div class="customer-cell">
              <i class="pi pi-user"></i>
              <div class="customer-info">
                <span class="customer-name">{{ parcel.senderName }}</span>
                <span class="customer-phone">{{ parcel.senderPhoneNumber }}</span>
              </div>
            </div>
          </td>

          <td>
            <div class="customer-cell">
              <i class="pi pi-user"></i>
              <div class="customer-info">
                <span class="customer-name">{{ parcel.receiverName }}</span>
                <span class="customer-phone">{{ parcel.receiverPhoneNumber }}</span>
              </div>
            </div>
          </td>

          <td>
            <div class="route-cell">
              <span class="route-point">
                <i class="pi pi-map-marker"></i>
                <span class="route-text">{{ parcel.sourceName }}</span>
              </span>
              <i class="pi pi-arrow-right route-arrow"></i>
              <span class="route-point">
                <i class="pi pi-map-marker"></i>
                <span class="route-text">{{ parcel.destinationName }}</span>
              </span>
            </div>
          </td>

          <td class="hide-mobile">
            <span class="fleet-badge">
              <i class="pi pi-car"></i>
              {{ parcel.fleetNo ?? 'N/A' }}
            </span>
          </td>

          <td class="amount-cell">
            <span class="amount">Ksh {{ parcel.amount | number : '1.2-2' }}</span>
          </td>

          <td class="hide-mobile">
            <span [class]="'badge ' + getPaymentMethodClass(parcel.paymentMethod)">
              <i [class]="parcel.paymentMethod === 'CASH' ? 'pi pi-money-bill' : 'pi pi-credit-card'"></i>
              {{ parcel.paymentMethod }}
            </span>
          </td>

          <td>
            <span [class]="'badge ' + getStatusClass(parcel.parcelStatus)">
              <i [class]="
                  parcel.parcelStatus === 'COLLECTED'
                    ? 'pi pi-check-circle'
                    : parcel.parcelStatus === 'IN_TRANSIT'
                      ? 'pi pi-truck'
                      : parcel.parcelStatus === 'ARRIVED'
                        ? 'pi pi-inbox'
                        : parcel.parcelStatus === 'CANCELLED'
                          ? 'pi pi-times-circle'
                          : 'pi pi-box'
                "></i>
              <span class="badge-text">{{ parcel.parcelStatus.replace('_', ' ') }}</span>
            </span>
          </td>

          <td>
            <button pButton icon="pi pi-file-pdf" class="p-button-rounded p-button-text receipt-btn"
              (click)="openReceipt(parcel); $event.stopPropagation()" pTooltip="View Receipt" tooltipPosition="left">
            </button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="empty-message">
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <h3>No Parcels Found</h3>
              <p>Try adjusting your filters or date range</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- ================= PARCEL DETAILS DIALOG ================= -->
  <p-dialog [(visible)]="displayDetailDialog" [modal]="true" [closable]="true" [dismissableMask]="true"
    [draggable]="false" [resizable]="false" styleClass="custom-dialog"
    [breakpoints]="{'960px': '90vw', '640px': '95vw'}" [style]="{ width: '90vw', maxWidth: '900px' }">
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <div class="dialog-header-top">
          <div class="dialog-icon">
            <i class="pi pi-box"></i>
          </div>
          <div class="dialog-title-section">
            <h2>Parcel Details</h2>
            <span class="receipt-number-large">{{ selectedParcel?.parcelNumber }}</span>
          </div>
        </div>
      </div>
    </ng-template>

    <div class="detail-content" *ngIf="selectedParcel">
      <div class="detail-grid">
        <!-- Left Column -->
        <div class="detail-column">
          <div class="detail-section">
            <h4 class="section-title">Parcel Information</h4>

            <div class="detail-item">
              <label>Parcel Number</label>
              <span class="value">{{ selectedParcel.parcelNumber }}</span>
            </div>

            <div class="detail-item">
              <label>Created Date</label>
              <span class="value">
                {{ selectedParcel.createdAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item">
              <label>Description</label>
              <span class="value">{{ selectedParcel.description || 'N/A' }}</span>
            </div>

            <div class="detail-item">
              <label>Parcel Value</label>
              <span class="value">Ksh {{ selectedParcel.value | number : '1.2-2' }}</span>
            </div>

            <div class="detail-item">
              <label>Service Charge</label>
              <span class="value">Ksh {{ selectedParcel.serviceCharge | number : '1.2-2' }}</span>
            </div>

            <div class="detail-item">
              <label>Total Amount</label>
              <span class="value amount-highlight">
                Ksh {{ selectedParcel.amount | number : '1.2-2' }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4 class="section-title">Sender Information</h4>

            <div class="detail-item">
              <label>Sender Name</label>
              <span class="value">{{ selectedParcel.senderName }}</span>
            </div>

            <div class="detail-item">
              <label>Sender Phone</label>
              <span class="value">{{ selectedParcel.senderPhoneNumber }}</span>
            </div>

            <div class="detail-item">
              <label>Source Location</label>
              <span class="value fleet-highlight">
                <i class="pi pi-map-marker"></i>
                {{ selectedParcel.sourceName }}
              </span>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="detail-column">
          <div class="detail-section">
            <h4 class="section-title">Delivery Information</h4>

            <div class="detail-item">
              <label>Receiver Name</label>
              <span class="value">{{ selectedParcel.receiverName }}</span>
            </div>

            <div class="detail-item">
              <label>Receiver Phone</label>
              <span class="value">{{ selectedParcel.receiverPhoneNumber }}</span>
            </div>

            <div class="detail-item">
              <label>Destination</label>
              <span class="value fleet-highlight">
                <i class="pi pi-map-marker"></i>
                {{ selectedParcel.destinationName }}
              </span>
            </div>

            <div class="detail-item">
              <label>Last Mile</label>
              <span class="value">{{ selectedParcel.lastMile || 'N/A' }}</span>
            </div>

            <div class="detail-item">
              <label>Fleet Number</label>
              <span class="value fleet-highlight">
                <i class="pi pi-car"></i>
                {{ selectedParcel.fleetNo }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4 class="section-title">Status & Payment</h4>

            <div class="detail-item">
              <label>Parcel Status</label>
              <span [class]="'value badge ' + getStatusClass(selectedParcel.parcelStatus)">
                {{ selectedParcel.parcelStatus.replace('_', ' ') }}
              </span>
            </div>

            <div class="detail-item">
              <label>Payment Status</label>
              <span [class]="'value badge ' + getPaymentStatusClass(selectedParcel.paymentStatus)">
                {{ selectedParcel.paymentStatus }}
              </span>
            </div>

            <div class="detail-item">
              <label>Payment Method</label>
              <span [class]="'value badge ' + getPaymentMethodClass(selectedParcel.paymentMethod)">
                {{ selectedParcel.paymentMethod }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.mpesaReceiptNumber">
              <label>M-Pesa Receipt</label>
              <span class="value code-value">{{ selectedParcel.mpesaReceiptNumber }}</span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.dispatchedAt">
              <label>Dispatched At</label>
              <span class="value">
                {{ selectedParcel.dispatchedAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.arrivedAt">
              <label>Arrived At</label>
              <span class="value">
                {{ selectedParcel.arrivedAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.pickedAt">
              <label>Picked At</label>
              <span class="value">
                {{ selectedParcel.pickedAt | date : 'dd MMM yyyy, hh:mm a' }}
              </span>
            </div>

            <div class="detail-item" *ngIf="selectedParcel.pickedBy">
              <label>Picked By</label>
              <span class="value">{{ selectedParcel.pickedBy }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <button pButton label="Close" icon="pi pi-times" class="p-button-text" (click)="closeDetailDialog()">
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- ================= PARCEL RECEIPT DIALOG ================= -->
  <p-dialog [(visible)]="displayReceiptDialog" [modal]="true" [closable]="true" [dismissableMask]="true"
    [draggable]="false" [resizable]="false" styleClass="custom-dialog"
    [breakpoints]="{'960px': '90vw', '640px': '95vw'}" [style]="{ width: '90vw', maxWidth: '900px' }">
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <div class="dialog-header-top">
          <div class="dialog-icon">
            <i class="pi pi-box"></i>
          </div>
          <div class="dialog-title-section">
            <h2>Parcel Receipt</h2>
            <span class="receipt-number-large">{{ selectedParcel?.parcelNumber }}</span>
          </div>
        </div>
      </div>
    </ng-template>

    <app-parcel-receipt *ngIf="selectedParcel" [parcel]="selectedParcel">
    </app-parcel-receipt>

    <ng-template pTemplate="footer">
      <div class="dialog-footer receipt-footer">
        <button pButton label="Simple" icon="pi pi-download" class="p-button-success receipt-download-btn"
          *ngIf="selectedParcel" [loading]="isSimpleReceiptDownloading" [disabled]="isSimpleReceiptDownloading"
          iconPos="right" style="gap: 0.5rem" (click)="generateSimpleReceipt()" pTooltip="Download simple receipt"
          tooltipPosition="top">
        </button>

        <button pButton label="Thermal" icon="pi pi-download" class="p-button-success receipt-download-btn"
          *ngIf="selectedParcel" [loading]="isThermalReceiptDownloading" [disabled]="isThermalReceiptDownloading"
          iconPos="right" style="gap: 0.5rem" (click)="generateThermalReceipt()" pTooltip="Download thermal receipt"
          tooltipPosition="top">
        </button>

        <button pButton label="Color" icon="pi pi-download" class="p-button-success receipt-download-btn"
          *ngIf="selectedParcel" [loading]="isColorReceiptDownloading" [disabled]="isColorReceiptDownloading"
          iconPos="right" style="gap: 0.5rem" (click)="downloadReceipt2(selectedParcel)"
          pTooltip="Download color receipt" tooltipPosition="top">
        </button>

        <button pButton label="Close" icon="pi pi-times" iconPos="right" style="gap: 0.5rem" class="p-button-text"
          (click)="closeReceiptDialog()">
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <p-toast position="top-right"></p-toast>
</div>